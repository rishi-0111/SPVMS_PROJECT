<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Notification Test Workflow</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 16px;
        }

        .progress-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .progress-step {
            flex: 1;
            text-align: center;
            position: relative;
            padding: 10px;
        }

        .progress-step::after {
            content: '';
            position: absolute;
            top: 20px;
            left: 50%;
            width: 100%;
            height: 3px;
            background: #e0e0e0;
            z-index: -1;
        }

        .progress-step:last-child::after {
            display: none;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #999;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 8px;
            transition: all 0.3s;
        }

        .progress-step.active .step-circle {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            transform: scale(1.1);
        }

        .progress-step.completed .step-circle {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .step-label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        .progress-step.active .step-label {
            color: #667eea;
            font-weight: 600;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .card.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card-title {
            font-size: 24px;
            color: #333;
            margin-bottom: 10px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }

        .card-description {
            color: #666;
            margin-bottom: 25px;
            line-height: 1.6;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
            font-size: 14px;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #48c6ef 0%, #6f86d6 100%);
        }

        .btn-back {
            background: #6c757d;
            flex: 0.5;
        }

        .result {
            margin-top: 20px;
            padding: 18px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
            display: none;
        }

        .result.success {
            background: #d4edda;
            border: 2px solid #c3e6cb;
            color: #155724;
            display: block;
        }

        .result.error {
            background: #f8d7da;
            border: 2px solid #f5c6cb;
            color: #721c24;
            display: block;
        }

        .info-box {
            background: #d1ecf1;
            border: 2px solid #bee5eb;
            color: #0c5460;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
        }

        .info-box strong {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .data-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #667eea;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-row:last-child {
            border-bottom: none;
        }

        .data-label {
            font-weight: 600;
            color: #666;
        }

        .data-value {
            color: #333;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .email-icon {
            font-size: 48px;
            text-align: center;
            margin: 20px 0;
        }

        .completion-message {
            text-align: center;
            padding: 30px;
        }

        .completion-message h2 {
            color: #11998e;
            font-size: 28px;
            margin-bottom: 15px;
        }

        .completion-checkmark {
            font-size: 72px;
            color: #38ef7d;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üìß Email Notification Test Workflow</h1>
            <p class="subtitle">Step-by-step testing of the procurement order email system</p>
        </div>

        <div class="progress-bar">
            <div class="progress-step active" id="progress-1">
                <div class="step-circle">1</div>
                <div class="step-label">Setup</div>
            </div>
            <div class="progress-step" id="progress-2">
                <div class="step-circle">2</div>
                <div class="step-label">Create Vendor</div>
            </div>
            <div class="progress-step" id="progress-3">
                <div class="step-circle">3</div>
                <div class="step-label">Create Order</div>
            </div>
            <div class="progress-step" id="progress-4">
                <div class="step-circle">4</div>
                <div class="step-label">Submit Order</div>
            </div>
            <div class="progress-step" id="progress-5">
                <div class="step-circle">5</div>
                <div class="step-label">Approve Order</div>
            </div>
            <div class="progress-step" id="progress-6">
                <div class="step-circle">6</div>
                <div class="step-label">View Emails</div>
            </div>
        </div>

        <div class="grid">
            <!-- Step 1: Configuration -->
            <div class="card active" id="step-1">
                <h2 class="card-title">Step 1: Email Configuration</h2>
                <div class="card-description">
                    <strong>üìù Before we start:</strong><br>
                    Enter the email addresses that will receive test notifications. These should be real email addresses you can check.
                </div>

                <div class="info-box">
                    <strong>üí° Tip:</strong>
                    Make sure your SMTP settings are configured in application.properties. The system will send real emails!
                </div>

                <div class="form-group">
                    <label>Your Email (Requester) üì®</label>
                    <input type="email" id="requesterEmail" placeholder="your-email@example.com" value="23102174@rmd.ac.in">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        This email will receive the "Order Approved" notification
                    </small>
                </div>

                <div class="form-group">
                    <label>Manager Email (Approver) üëî</label>
                    <input type="email" id="managerEmail" placeholder="manager@example.com" value="manager@example.com">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        This email will receive the "Order Submitted" notification
                    </small>
                </div>

                <div class="button-group">
                    <button onclick="goToStep(2)">Next: Create Vendor ‚ûú</button>
                </div>
            </div>

            <!-- Step 2: Create Vendor -->
            <div class="card" id="step-2">
                <h2 class="card-title">Step 2: Create a Test Vendor</h2>
                <div class="card-description">
                    <strong>üè¢ Create a vendor</strong><br>
                    First, we need a vendor in the system. You can use the default values or customize them.
                </div>

                <div class="form-group">
                    <label>Vendor Name</label>
                    <input type="text" id="vendorName" placeholder="Enter vendor name" value="Test Supplies Co">
                </div>

                <div class="form-group">
                    <label>Delivery Rate (%)</label>
                    <input type="number" id="deliveryRate" placeholder="95.5" step="0.1" min="0" max="100" value="95.5">
                </div>

                <div class="form-group">
                    <label>Quality Rating (0-5)</label>
                    <input type="number" id="qualityRating" placeholder="4.5" step="0.1" min="0" max="5" value="4.5">
                </div>

                <div class="form-group">
                    <label>Price Score (0-100)</label>
                    <input type="number" id="priceScore" placeholder="85" min="0" max="100" value="85">
                </div>

                <div id="vendorResult" class="result"></div>

                <div class="button-group">
                    <button class="btn-back" onclick="goToStep(1)">‚Üê Back</button>
                    <button onclick="createVendor()">Create Vendor</button>
                </div>
            </div>

            <!-- Step 3: Create Order -->
            <div class="card" id="step-3">
                <h2 class="card-title">Step 3: Create Procurement Order</h2>
                <div class="card-description">
                    <strong>üì¶ Create an order</strong><br>
                    Now let's create a procurement order that will trigger email notifications.
                </div>

                <div class="data-display" id="vendorInfo" style="display:none;">
                    <div class="data-row">
                        <span class="data-label">Vendor ID:</span>
                        <span class="data-value" id="displayVendorId">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Vendor Name:</span>
                        <span class="data-value" id="displayVendorName">-</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>Item Name</label>
                    <input type="text" id="itemName" placeholder="Office Supplies" value="Office Supplies">
                </div>

                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" id="itemQty" placeholder="100" value="50">
                </div>

                <div class="form-group">
                    <label>Unit Price ($)</label>
                    <input type="number" id="itemPrice" placeholder="5.50" step="0.01" value="25.00">
                </div>

                <div class="form-group">
                    <label>Order Notes</label>
                    <textarea id="ordNotes" rows="2" placeholder="Additional notes...">Test order for email notification workflow</textarea>
                </div>

                <div id="orderResult" class="result"></div>

                <div class="button-group">
                    <button class="btn-back" onclick="goToStep(2)">‚Üê Back</button>
                    <button onclick="createOrder()">Create Order</button>
                </div>
            </div>

            <!-- Step 4: Submit Order -->
            <div class="card" id="step-4">
                <h2 class="card-title">Step 4: Submit Order for Approval</h2>
                <div class="card-description">
                    <strong>üì§ Submit the order</strong><br>
                    This will change the order status to PENDING_APPROVAL and send an email to the approver (manager).
                </div>

                <div class="email-icon">üìß</div>

                <div class="info-box">
                    <strong>üì® Email Alert:</strong>
                    When you click "Submit Order", an email will be sent to: <strong id="displayManagerEmail"></strong>
                    <br><br>
                    Check your inbox for "New Procurement Order Submitted for Your Approval"
                </div>

                <div class="data-display" id="orderInfo" style="display:none;">
                    <div class="data-row">
                        <span class="data-label">Order ID:</span>
                        <span class="data-value" id="displayOrderId">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Order Number:</span>
                        <span class="data-value" id="displayOrderNumber">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Total Amount:</span>
                        <span class="data-value" id="displayTotalAmount">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Current Status:</span>
                        <span class="badge badge-warning" id="displayOrderStatus">DRAFT</span>
                    </div>
                </div>

                <div id="submitResult" class="result"></div>

                <div class="button-group">
                    <button class="btn-back" onclick="goToStep(3)">‚Üê Back</button>
                    <button onclick="submitOrder()">Submit Order (Send Email)</button>
                </div>
            </div>

            <!-- Step 5: Approve Order -->
            <div class="card" id="step-5">
                <h2 class="card-title">Step 5: Approve the Order</h2>
                <div class="card-description">
                    <strong>‚úÖ Approve the order</strong><br>
                    This will approve the order and send an email to the requester confirming approval.
                </div>

                <div class="email-icon">üìß</div>

                <div class="info-box">
                    <strong>üì® Email Alert:</strong>
                    When you click "Approve Order", an email will be sent to: <strong id="displayRequesterEmail"></strong>
                    <br><br>
                    Check your inbox for "Your Procurement Order Has Been Approved"
                </div>

                <div class="data-display">
                    <div class="data-row">
                        <span class="data-label">Order Number:</span>
                        <span class="data-value" id="displayOrderNumber2">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Current Status:</span>
                        <span class="badge badge-info">PENDING_APPROVAL</span>
                    </div>
                </div>

                <div id="approveResult" class="result"></div>

                <div class="button-group">
                    <button class="btn-back" onclick="goToStep(4)">‚Üê Back</button>
                    <button onclick="approveOrder()">Approve Order (Send Email)</button>
                </div>
            </div>

            <!-- Step 6: View Results -->
            <div class="card" id="step-6">
                <h2 class="card-title">Step 6: View Email Logs</h2>

                <div class="completion-message">
                    <div class="completion-checkmark">‚úÖ</div>
                    <h2>Workflow Complete!</h2>
                    <p style="color: #666; margin-bottom: 20px;">
                        Two emails should have been sent. Check the logs below and your email inbox.
                    </p>
                </div>

                <div class="info-box">
                    <strong>üìä What to check:</strong>
                    1. Email logs in the system (below)<br>
                    2. Your actual email inbox for both notifications<br>
                    3. Email status (SENT or FAILED)<br>
                    4. Email retry count
                </div>

                <div class="button-group" style="margin-bottom: 20px;">
                    <button onclick="viewOrderEmails()">View Emails for This Order</button>
                    <button class="btn-secondary" onclick="viewAllEmails()">View All Emails</button>
                </div>

                <div id="emailResult" class="result"></div>

                <div class="button-group" style="margin-top: 20px;">
                    <button class="btn-back" onclick="goToStep(1)">‚Üª Start New Test</button>
                    <button class="btn-secondary" onclick="retryFailedEmails()">Retry Failed Emails</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        let currentStep = 1;
        let workflowData = {
            vendorId: null,
            vendorName: null,
            orderId: null,
            orderNumber: null,
            totalAmount: null,
            requesterEmail: null,
            managerEmail: null
        };

        function goToStep(step) {
            // Update progress bar
            for (let i = 1; i <= 6; i++) {
                const progressStep = document.getElementById(`progress-${i}`);
                const card = document.getElementById(`step-${i}`);

                if (i < step) {
                    progressStep.classList.remove('active');
                    progressStep.classList.add('completed');
                } else if (i === step) {
                    progressStep.classList.add('active');
                    progressStep.classList.remove('completed');
                } else {
                    progressStep.classList.remove('active', 'completed');
                }

                card.classList.toggle('active', i === step);
            }

            currentStep = step;

            // Update display data when moving to certain steps
            if (step === 3 && workflowData.vendorId) {
                document.getElementById('vendorInfo').style.display = 'block';
                document.getElementById('displayVendorId').textContent = workflowData.vendorId;
                document.getElementById('displayVendorName').textContent = workflowData.vendorName;
            }

            if (step === 4 && workflowData.orderId) {
                document.getElementById('orderInfo').style.display = 'block';
                document.getElementById('displayOrderId').textContent = workflowData.orderId;
                document.getElementById('displayOrderNumber').textContent = workflowData.orderNumber;
                document.getElementById('displayTotalAmount').textContent = '$' + workflowData.totalAmount;
                document.getElementById('displayManagerEmail').textContent = workflowData.managerEmail;
            }

            if (step === 5) {
                document.getElementById('displayOrderNumber2').textContent = workflowData.orderNumber;
                document.getElementById('displayRequesterEmail').textContent = workflowData.requesterEmail;
            }

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showResult(elementId, message, isError = false) {
            const el = document.getElementById(elementId);
            el.className = `result ${isError ? 'error' : 'success'}`;
            el.innerHTML = message;
        }

        async function apiCall(url, method = 'GET', body = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'userId': 'test-user'
                }
            };

            if (body) {
                options.body = JSON.stringify(body);
            }

            const response = await fetch(API_BASE + url, options);
            const data = await response.json();

            if (!response.ok) {
                throw new Error(JSON.stringify(data, null, 2));
            }

            return data;
        }

        async function createVendor() {
            try {
                workflowData.requesterEmail = document.getElementById('requesterEmail').value;
                workflowData.managerEmail = document.getElementById('managerEmail').value;

                const data = await apiCall('/api/vendors', 'POST', {
                    name: document.getElementById('vendorName').value,
                    deliveryRate: parseFloat(document.getElementById('deliveryRate').value),
                    qualityRating: parseFloat(document.getElementById('qualityRating').value),
                    priceScore: parseFloat(document.getElementById('priceScore').value)
                });

                workflowData.vendorId = data.id;
                workflowData.vendorName = data.name;

                showResult('vendorResult', `
                    <strong>‚úÖ Vendor Created Successfully!</strong><br><br>
                    <strong>Vendor ID:</strong> ${data.id}<br>
                    <strong>Name:</strong> ${data.name}<br>
                    <strong>Performance Score:</strong> ${data.performanceScore.toFixed(2)}<br><br>
                    <button onclick="goToStep(3)" style="margin-top: 10px;">Next: Create Order ‚ûú</button>
                `);
            } catch (error) {
                showResult('vendorResult', `<strong>‚ùå Error Creating Vendor:</strong><br><pre>${error.message}</pre>`, true);
            }
        }

        async function createOrder() {
            try {
                const data = await apiCall('/api/procurement/orders', 'POST', {
                    vendorId: workflowData.vendorId,
                    requestedBy: workflowData.requesterEmail,
                    items: [{
                        itemName: document.getElementById('itemName').value,
                        description: 'Test item',
                        quantity: parseInt(document.getElementById('itemQty').value),
                        unitPrice: parseFloat(document.getElementById('itemPrice').value)
                    }],
                    notes: document.getElementById('ordNotes').value
                });

                workflowData.orderId = data.id;
                workflowData.orderNumber = data.orderNumber;
                workflowData.totalAmount = data.totalAmount.toFixed(2);

                showResult('orderResult', `
                    <strong>‚úÖ Order Created Successfully!</strong><br><br>
                    <strong>Order Number:</strong> ${data.orderNumber}<br>
                    <strong>Order ID:</strong> ${data.id}<br>
                    <strong>Status:</strong> <span class="badge badge-warning">${data.status}</span><br>
                    <strong>Total Amount:</strong> $${data.totalAmount.toFixed(2)}<br><br>
                    <button onclick="goToStep(4)" style="margin-top: 10px;">Next: Submit Order ‚ûú</button>
                `);
            } catch (error) {
                showResult('orderResult', `<strong>‚ùå Error Creating Order:</strong><br><pre>${error.message}</pre>`, true);
            }
        }

        async function submitOrder() {
            try {
                const data = await apiCall(`/api/procurement/orders/${workflowData.orderId}/submit`, 'POST');

                showResult('submitResult', `
                    <strong>‚úÖ Order Submitted Successfully!</strong><br><br>
                    <strong>Order Number:</strong> ${data.orderNumber}<br>
                    <strong>New Status:</strong> <span class="badge badge-info">${data.status}</span><br><br>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <strong>üìß Email Sent!</strong><br>
                        An approval request email has been sent to:<br>
                        <strong>${workflowData.managerEmail}</strong><br><br>
                        Subject: "New Procurement Order Submitted for Your Approval"
                    </div><br>
                    <button onclick="goToStep(5)" style="margin-top: 10px;">Next: Approve Order ‚ûú</button>
                `);
            } catch (error) {
                showResult('submitResult', `<strong>‚ùå Error Submitting Order:</strong><br><pre>${error.message}</pre>`, true);
            }
        }

        async function approveOrder() {
            try {
                const data = await apiCall(
                    `/api/procurement/orders/${workflowData.orderId}/approve?approver=${encodeURIComponent(workflowData.managerEmail)}`,
                    'POST'
                );

                showResult('approveResult', `
                    <strong>‚úÖ Order Approved Successfully!</strong><br><br>
                    <strong>Order Number:</strong> ${data.orderNumber}<br>
                    <strong>New Status:</strong> <span class="badge badge-success">${data.status}</span><br>
                    <strong>Approved By:</strong> ${data.approvedBy}<br>
                    <strong>Approved At:</strong> ${data.approvedAt}<br><br>
                    <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <strong>üìß Email Sent!</strong><br>
                        An approval confirmation email has been sent to:<br>
                        <strong>${workflowData.requesterEmail}</strong><br><br>
                        Subject: "Your Procurement Order Has Been Approved"
                    </div><br>
                    <button onclick="goToStep(6)" style="margin-top: 10px;">Next: View Emails ‚ûú</button>
                `);
            } catch (error) {
                showResult('approveResult', `<strong>‚ùå Error Approving Order:</strong><br><pre>${error.message}</pre>`, true);
            }
        }

        async function viewOrderEmails() {
            try {
                const emails = await apiCall(`/api/admin/emails/order/${workflowData.orderId}`);

                let html = '<strong>üìß Email Logs for This Order</strong><br><br>';

                if (emails.length === 0) {
                    html += '<div class="info-box">No emails found for this order yet. They may still be processing.</div>';
                } else {
                    emails.forEach(e => {
                        const statusBadge = e.status === 'SENT' ? 'badge-success' : 'badge-warning';
                        const icon = e.status === 'SENT' ? '‚úÖ' : '‚è≥';

                        html += `
                            <div class="data-display" style="margin-bottom: 15px;">
                                <div class="data-row">
                                    <span class="data-label">${icon} Email ${e.id}</span>
                                    <span class="badge ${statusBadge}">${e.status}</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">Subject:</span>
                                    <span class="data-value">${e.subject}</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">To:</span>
                                    <span class="data-value">${e.recipient}</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">Retry Count:</span>
                                    <span class="data-value">${e.retryCount}</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">Created:</span>
                                    <span class="data-value">${e.createdAt}</span>
                                </div>
                                ${e.sentAt ? `
                                <div class="data-row">
                                    <span class="data-label">Sent:</span>
                                    <span class="data-value">${e.sentAt}</span>
                                </div>` : ''}
                                ${e.errorMessage ? `
                                <div class="data-row">
                                    <span class="data-label">Error:</span>
                                    <span class="data-value" style="color: #d63031;">${e.errorMessage}</span>
                                </div>` : ''}
                            </div>
                        `;
                    });
                }

                showResult('emailResult', html);
            } catch (error) {
                showResult('emailResult', `<strong>‚ùå Error Fetching Emails:</strong><br><pre>${error.message}</pre>`, true);
            }
        }

        async function viewAllEmails() {
            try {
                const emails = await apiCall('/api/admin/emails');

                let html = '<strong>üìß All Email Logs in System</strong><br><br>';

                if (emails.length === 0) {
                    html += '<div class="info-box">No emails in the system yet.</div>';
                } else {
                    emails.slice(0, 10).forEach(e => {
                        const statusBadge = e.status === 'SENT' ? 'badge-success' : 'badge-warning';
                        const icon = e.status === 'SENT' ? '‚úÖ' : '‚è≥';

                        html += `
                            <div class="data-display" style="margin-bottom: 10px;">
                                <div class="data-row">
                                    <span class="data-label">${icon} ${e.subject}</span>
                                    <span class="badge ${statusBadge}">${e.status}</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">To:</span>
                                    <span class="data-value">${e.recipient}</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">Order ID:</span>
                                    <span class="data-value">${e.relatedOrderId || 'N/A'}</span>
                                </div>
                            </div>
                        `;
                    });

                    if (emails.length > 10) {
                        html += `<div class="info-box">Showing 10 of ${emails.length} emails</div>`;
                    }
                }

                showResult('emailResult', html);
            } catch (error) {
                showResult('emailResult', `<strong>‚ùå Error Fetching Emails:</strong><br><pre>${error.message}</pre>`, true);
            }
        }

        async function retryFailedEmails() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/emails/retry-all`, {
                    method: 'POST',
                    headers: { 'userId': 'test-user' }
                });
                const message = await response.text();

                showResult('emailResult', `<strong>‚úÖ ${message}</strong><br>Check the logs again in a few seconds.`);

                // Auto-refresh after 3 seconds
                setTimeout(() => viewOrderEmails(), 3000);
            } catch (error) {
                showResult('emailResult', `<strong>‚ùå Error:</strong><br>${error.message}`, true);
            }
        }

        // Initialize on page load
        window.onload = function() {
            goToStep(1);
        };
    </script>
</body>

</html>